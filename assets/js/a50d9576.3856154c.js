"use strict";(self.webpackChunk_bonfhir_docs=self.webpackChunk_bonfhir_docs||[]).push([[690],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=p(a),d=r,m=c["".concat(s,".").concat(d)]||c[d]||h[d]||l;return a?n.createElement(m,i(i({ref:t},u),{},{components:a})):n.createElement(m,i({ref:t},u))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[c]="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},3886:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>p,toc:()=>c});var n=a(7462),r=(a(7294),a(3905)),l=a(4866),i=a(5162);const o={sidebar_position:2},s="Code generation",p={unversionedId:"codegen",id:"codegen",title:"Code generation",description:"The FHIR standard is formally specified in an implementation guide.",source:"@site/contributing/codegen.md",sourceDirName:".",slug:"/codegen",permalink:"/contributing/codegen",draft:!1,editUrl:"https://github.com/bonfhir/bonfhir/tree/main/packages/docs/contributing/codegen.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Contributing",permalink:"/contributing/contributing"}},u={},c=[{value:"Using it in your own projects and packages",id:"using-it-in-your-own-projects-and-packages",level:2},{value:"Template helpers",id:"template-helpers",level:2},{value:"<code>elementImmediatePath</code>",id:"elementimmediatepath",level:3},{value:"<code>fhirPath</code>",id:"fhirpath",level:3},{value:"<code>in/notIn</code>",id:"innotin",level:3},{value:"<code>readLines</code>",id:"readlines",level:3},{value:"<code>recursiveFlatten</code>",id:"recursiveflatten",level:3},{value:"<code>safeNameAsVar</code>",id:"safenameasvar",level:3},{value:"<code>valueSetExpansions</code>",id:"valuesetexpansions",level:3},{value:"<code>writeFiles</code>",id:"writefiles",level:3}],h={toc:c};function d(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"code-generation"},"Code generation"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://hl7.org/fhir/index.html"},"FHIR standard")," is formally specified ",(0,r.kt)("a",{parentName:"p",href:"https://hl7.org/fhir/downloads.html"},"in an implementation guide"),"."),(0,r.kt)("p",null,"There is an opportunity to use these formal specifications to generate code for implementation.\nThis is the strategy chosen for a number of Bonfhir packages."),(0,r.kt)("p",null,"The FHIR Definition files (as JSON) are stored in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bonfhir/bonfhir/tree/main/fhir"},(0,r.kt)("inlineCode",{parentName:"a"},"/fhir"))," folder, by their respective versions."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"codegen")," package provides a utility that can assist in generating code based on the FHIR definition files."),(0,r.kt)("p",null,"While the best to understand how code generation work is to inspect how some of the Bonfhir packages are built (e.g. the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bonfhir/bonfhir/tree/main/packages/core"},(0,r.kt)("inlineCode",{parentName:"a"},"core package")),", here is a quick guide to get started:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"each target package can contain one or more template files (usually using the ",(0,r.kt)("inlineCode",{parentName:"li"},".hbs")," extension)"),(0,r.kt)("li",{parentName:"ul"},"templates use the ",(0,r.kt)("a",{parentName:"li",href:"https://handlebarsjs.com/"},"handlebars")," templating language, with additional ",(0,r.kt)("a",{parentName:"li",href:"#template-helpers"},"helpers")," provided"),(0,r.kt)("li",{parentName:"ul"},"FHIR definition files can be loaded as the context to run the templates and generate source code")),(0,r.kt)("p",null,"The codegen CLI orchestrate the process by roughly executing ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bonfhir/bonfhir/blob/8c927f5469dd570fe55f9cdb86dad230403d204d/packages/codegen/src/commands/run/index.ts#L38"},"the following steps"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"load data files (usually FHIR definitions, but it can be any JSON file really) as the template evaluation context"),(0,r.kt)("li",{parentName:"ul"},"load custom javascript helpers (in the form of a Javascript file) that gets injected in the template context as well"),(0,r.kt)("li",{parentName:"ul"},"scan the target package for template files to execute"),(0,r.kt)("li",{parentName:"ul"},"render the template files one by one; template may render additional files by using the ",(0,r.kt)("a",{parentName:"li",href:"#writefiles"},(0,r.kt)("inlineCode",{parentName:"a"},"writeFiles"))," helper",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"by default, the target file name for the generated file is the template name minus the extension (e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"index.ts.hbs")," -> ",(0,r.kt)("inlineCode",{parentName:"li"},"index.ts"),")"))),(0,r.kt)("li",{parentName:"ul"},"execute any post-processing task on the generated files, such as running Prettier to format the code properly for example")),(0,r.kt)("p",null,"And this is all that's needed to generate code using FHIR specifications. You can find many examples throughout the Bonfhir codebase - look for ",(0,r.kt)("inlineCode",{parentName:"p"},".hbs")," files."),(0,r.kt)("h2",{id:"using-it-in-your-own-projects-and-packages"},"Using it in your own projects and packages"),(0,r.kt)("p",null,"It is possible to independently use the ",(0,r.kt)("inlineCode",{parentName:"p"},"codegen")," package in your own projects."),(0,r.kt)("p",null,"Here is how to get started:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Install the package as a development dependency")),(0,r.kt)(l.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"npm",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm install --save-dev @bonfhir/codegen\n"))),(0,r.kt)(i.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add --dev @bonfhir/codegen\n")))),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download FHIR definition files from ",(0,r.kt)("a",{parentName:"p",href:"https://hl7.org/fhir/downloads.html"},"https://hl7.org/fhir/downloads.html")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"We recommend using the ",(0,r.kt)("a",{parentName:"li",href:"https://hl7.org/fhir/definitions.json.zip"},"JSON FHIR Definitions")," as they are easier to work with generally."),(0,r.kt)("li",{parentName:"ul"},"If needed, you may also want to use ",(0,r.kt)("a",{parentName:"li",href:"https://hl7.org/fhir/expansions.json"},"ValueSet expansions")," as well"),(0,r.kt)("li",{parentName:"ul"},"Any additional custom ",(0,r.kt)("a",{parentName:"li",href:"https://hl7.org/fhir/profiling.html"},"FHIR Profile")," may also be used"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Author your templates using the ",(0,r.kt)("a",{parentName:"p",href:"https://handlebarsjs.com/guide/"},"handlebars")," syntax; you can leverage the ",(0,r.kt)("a",{parentName:"p",href:"#template-helpers"},"built-in codegen helpers"),", and add you own helpers in a javascript file as well.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Run the code generation:"))),(0,r.kt)(l.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"npm",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'npm run bonfhir-codegen run --data-json "<path to FHIR specification files>/**/*.json" --templates "<path to your project files>/**/*.hbs" --helpers "./<path to your custom helpers file if any>.js" --post-processing "prettier --write %files%"\n'))),(0,r.kt)(i.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'yarn bonfhir-codegen run --data-json "<path to FHIR specification files>/**/*.json" --templates "<path to your project files>/**/*.hbs" --helpers "./<path to your custom helpers file if any>.js" --post-processing "prettier --write %files%"\n')))),(0,r.kt)("h2",{id:"template-helpers"},"Template helpers"),(0,r.kt)("p",null,"The codegen package injects custom helpers to simplify authorship of templates:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"All the ",(0,r.kt)("a",{parentName:"li",href:"https://handlebarsjs.com/guide/builtin-helpers.html"},"Built-in Handlebar Helpers")),(0,r.kt)("li",{parentName:"ul"},"All the helpers provided by the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/helpers/handlebars-helpers"},"handlebars-helpers")," package"),(0,r.kt)("li",{parentName:"ul"},"The following ",(0,r.kt)("a",{parentName:"li",href:"https://lodash.com/"},"Lodash")," functions:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://lodash.com/docs/4.17.15#startCase"},"startCase")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://lodash.com/docs/4.17.15#uniq"},"uniq")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://lodash.com/docs/4.17.15#uniqBy"},"uniqBy"))))),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"codegen")," package also provides some additional helpers - ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bonfhir/bonfhir/tree/main/packages/codegen/src/commands/run/helpers"},"the exhaustive list to be found in the source code"),"."),(0,r.kt)("p",null,"Some notable helpers:"),(0,r.kt)("h3",{id:"elementimmediatepath"},(0,r.kt)("inlineCode",{parentName:"h3"},"elementImmediatePath")),(0,r.kt)("p",null,"Return the immediate path for a FHIR ",(0,r.kt)("a",{parentName:"p",href:"https://hl7.org/fhir/elementdefinition.html#ElementDefinition"},"Element Definition")," path property."),(0,r.kt)("h3",{id:"fhirpath"},(0,r.kt)("inlineCode",{parentName:"h3"},"fhirPath")),(0,r.kt)("p",null,"Returns the result of evaluating a ",(0,r.kt)("a",{parentName:"p",href:"http://hl7.org/fhirpath/N1/"},"FHIRPath")," against a resource."),(0,r.kt)("p",null,'Example, to list all the Domain Resources listed in the FHIR Definition file named "profiles-resources.json":'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-handlebars"},'{{#each\n  (fhirPath\n    data.profiles-resources\n    "Bundle.entry.select(resource).ofType(StructureDefinition).where(baseDefinition=\'http://hl7.org/fhir/StructureDefinition/DomainResource\' and abstract=false)"\n  )\n}}\n  import type {\n  {{type}}\n  } from "fhir/r4";\n{{/each}}\n')),(0,r.kt)("p",null,"The helper contains also ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bonfhir/bonfhir/blob/main/packages/codegen/src/commands/run/helpers/fhirPath.ts#L3"},"a list of useful aliases")," to common FHIR Path requests.\nHere is how the example can also be written:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-handlebars"},'{{#each (fhirPath data.profiles-resources "Bundle/DomainResources")}}\n  import type {\n  {{type}}\n  } from "fhir/r4";\n{{/each}}\n')),(0,r.kt)("h3",{id:"innotin"},(0,r.kt)("inlineCode",{parentName:"h3"},"in/notIn")),(0,r.kt)("p",null,"Filter if it is / it is not in a list of values."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-handlebars"},'{{#each (fhirPath data.profiles-resources "Bundle/DomainResources")}}\n  {{#if (in name "Account,Patient")}}\n    ...\n  {{/if}}\n{{/each}}\n')),(0,r.kt)("h3",{id:"readlines"},(0,r.kt)("inlineCode",{parentName:"h3"},"readLines")),(0,r.kt)("p",null,"Load text file and return an array with each line as a string. Ignores empty lines.\nLoad path is relative to the template file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-handlebars"},'{{#if (in name (readLines "namesToKeep.txt"))}}\n  ...\n{{/if}}\n')),(0,r.kt)("h3",{id:"recursiveflatten"},(0,r.kt)("inlineCode",{parentName:"h3"},"recursiveFlatten")),(0,r.kt)("p",null,"Depth-first recursive exploration of an array using a single attribute."),(0,r.kt)("h3",{id:"safenameasvar"},(0,r.kt)("inlineCode",{parentName:"h3"},"safeNameAsVar")),(0,r.kt)("p",null,"Returns a string that can safely be used as a Typescript variable name"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-handlebars"},'{{#safeNameAsVar "12 ab"}} -> "twelveab"\n')),(0,r.kt)("h3",{id:"valuesetexpansions"},(0,r.kt)("inlineCode",{parentName:"h3"},"valueSetExpansions")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://hl7.org/fhir/valueset.html#expansion"},"Expand")," a ",(0,r.kt)("inlineCode",{parentName:"p"},"ValueSet")," using FHIR definition files."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Implementation is currently limited and do not support advanced filtering capabilities.\nIt is only here to support codegen on the ",(0,r.kt)("a",{parentName:"em",href:"/packages/foundation/terminology"},"Terminology package"))),(0,r.kt)("h3",{id:"writefiles"},(0,r.kt)("inlineCode",{parentName:"h3"},"writeFiles")),(0,r.kt)("p",null,"Allows rendering the content in a different file than the root of the template file.\nThe filename itself is also a template, which means it can be used in a loop."),(0,r.kt)("p",null,"Example to write one file per domain resource, each with a class with the name of the resource:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-handlebars"},'{{#each (fhirPath data.profiles-resources "Bundle/DomainResources")}}\n  {{#writeFile "{{type}}.ts"}}\n    class\n    {{type}}\n    {}\n  {{/writeFile}}\n{{/each}}\n')))}d.isMDXComponent=!0},5162:(e,t,a)=>{a.d(t,{Z:()=>i});var n=a(7294),r=a(6010);const l="tabItem_Ymn6";function i(e){let{children:t,hidden:a,className:i}=e;return n.createElement("div",{role:"tabpanel",className:(0,r.Z)(l,i),hidden:a},t)}},4866:(e,t,a)=>{a.d(t,{Z:()=>w});var n=a(7462),r=a(7294),l=a(6010),i=a(2466),o=a(6550),s=a(1980),p=a(7392),u=a(12);function c(e){return function(e){return r.Children.map(e,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))}(e).map((e=>{let{props:{value:t,label:a,attributes:n,default:r}}=e;return{value:t,label:a,attributes:n,default:r}}))}function h(e){const{values:t,children:a}=e;return(0,r.useMemo)((()=>{const e=t??c(a);return function(e){const t=(0,p.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,a])}function d(e){let{value:t,tabValues:a}=e;return a.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:a}=e;const n=(0,o.k6)(),l=function(e){let{queryString:t=!1,groupId:a}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:t,groupId:a});return[(0,s._X)(l),(0,r.useCallback)((e=>{if(!l)return;const t=new URLSearchParams(n.location.search);t.set(l,e),n.replace({...n.location,search:t.toString()})}),[l,n])]}function f(e){const{defaultValue:t,queryString:a=!1,groupId:n}=e,l=h(e),[i,o]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const n=a.find((e=>e.default))??a[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:l}))),[s,p]=m({queryString:a,groupId:n}),[c,f]=function(e){let{groupId:t}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(t),[n,l]=(0,u.Nk)(a);return[n,(0,r.useCallback)((e=>{a&&l.set(e)}),[a,l])]}({groupId:n}),g=(()=>{const e=s??c;return d({value:e,tabValues:l})?e:null})();(0,r.useLayoutEffect)((()=>{g&&o(g)}),[g]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!d({value:e,tabValues:l}))throw new Error(`Can't select invalid tab value=${e}`);o(e),p(e),f(e)}),[p,f,l]),tabValues:l}}var g=a(2389);const k="tabList__CuJ",b="tabItem_LNqP";function y(e){let{className:t,block:a,selectedValue:o,selectValue:s,tabValues:p}=e;const u=[],{blockElementScrollPositionUntilNextRender:c}=(0,i.o5)(),h=e=>{const t=e.currentTarget,a=u.indexOf(t),n=p[a].value;n!==o&&(c(t),s(n))},d=e=>{let t=null;switch(e.key){case"Enter":h(e);break;case"ArrowRight":{const a=u.indexOf(e.currentTarget)+1;t=u[a]??u[0];break}case"ArrowLeft":{const a=u.indexOf(e.currentTarget)-1;t=u[a]??u[u.length-1];break}}t?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":a},t)},p.map((e=>{let{value:t,label:a,attributes:i}=e;return r.createElement("li",(0,n.Z)({role:"tab",tabIndex:o===t?0:-1,"aria-selected":o===t,key:t,ref:e=>u.push(e),onKeyDown:d,onClick:h},i,{className:(0,l.Z)("tabs__item",b,i?.className,{"tabs__item--active":o===t})}),a??t)})))}function v(e){let{lazy:t,children:a,selectedValue:n}=e;if(a=Array.isArray(a)?a:[a],t){const e=a.find((e=>e.props.value===n));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},a.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==n}))))}function N(e){const t=f(e);return r.createElement("div",{className:(0,l.Z)("tabs-container",k)},r.createElement(y,(0,n.Z)({},e,t)),r.createElement(v,(0,n.Z)({},e,t)))}function w(e){const t=(0,g.Z)();return r.createElement(N,(0,n.Z)({key:String(t)},e))}}}]);